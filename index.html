<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上點餐</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-amber-50 flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
        <h1 class="text-3xl font-extrabold text-center text-amber-800 border-b-4 border-amber-200 pb-4 mb-6">線上點餐</h1>

        <!-- 訂單摘要區塊 -->
        <div class="summary bg-amber-100 rounded-xl p-5 mb-6 border border-amber-200">
            <h2 class="text-xl font-semibold text-center text-amber-700 pb-2 mb-4 border-b border-200">您的訂單</h2>
            <div id="order-summary-list" class="text-left text-gray-700">
                <!-- 訂單項目將由 JavaScript 載入 -->
                <p class="text-gray-400">目前沒有商品在訂單中。</p>
            </div>
            <p class="text-lg font-bold text-right mt-4 text-amber-800">總計: <span id="total-price" class="text-red-600">$0</span></p>
        </div>
        
        <form id="orderForm" action="https://docs.google.com/forms/d/e/1FAIpQLSdhFpc-NlcsF2lLo-vj6dctP31sOv1sNHqwT1VONeEEoWay8g/formResponse" method="post" target="_blank">

            <!-- 手機號碼輸入區塊 -->
            <div class="phone-input text-center my-4">
                <label for="phone-number" class="block font-medium text-gray-700 mb-1">請輸入手機末4碼：</label>
                <input type="tel" id="phone-number" name="entry.1315976870" placeholder="後4碼" maxlength="4" required class="border border-amber-300 rounded-lg p-2 text-center w-36 focus:ring-2 focus:ring-amber-500 focus:outline-none transition duration-200">
            </div>

            <!-- Google 表單隱藏欄位 -->
            <input type="hidden" name="entry.1578389310" id="order-details-input">
            <input type="hidden" name="entry.1761228994" id="total-price-input">

            <!-- 主食區塊 -->
            <h2 class="text-xl font-semibold mt-6 mb-4 text-amber-700 border-b-2 border-amber-200 pb-2">主食</h2>

            <!-- 麻婆豆腐蓋飯 - 辣度選項已修改 -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="麻婆豆腐蓋飯">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">麻婆豆腐蓋飯</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="mapo-small" name="mapo-size" value="小" data-price="65" checked class="accent-amber-500">
                        <label for="mapo-small" class="text-gray-600">小 ($65)</label>
                        <input type="radio" id="mapo-large" name="mapo-size" value="大" data-price="75" class="accent-amber-500">
                        <label for="mapo-large" class="text-gray-600">大 ($75)</label>
                    </div>
                    <!-- 移除不辣選項，現在必選辣度 -->
                    <div class="spicy-options flex items-center gap-4 mt-2">
                        <input type="radio" id="mapo-mild" name="mapo-spicy" value="小辣" checked class="accent-red-500">
                        <label for="mapo-mild" class="text-gray-600">小辣</label>
                        <input type="radio" id="mapo-medium" name="mapo-spicy" value="中辣" class="accent-red-500">
                        <label for="mapo-medium" class="text-gray-600">中辣</label>
                        <input type="radio" id="mapo-hot" name="mapo-spicy" value="大辣" class="accent-red-500">
                        <label for="mapo-hot" class="text-gray-600">大辣</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>
            
            <!-- 馬鈴薯燉肉蓋飯 (豬) -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="馬鈴薯燉肉蓋飯 (豬)">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">馬鈴薯燉肉蓋飯 (豬)</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="potato-small" name="potato-size" value="小" data-price="65" checked class="accent-amber-500">
                        <label for="potato-small" class="text-gray-600">小 ($65)</label>
                        <input type="radio" id="potato-large" name="potato-size" value="大" data-price="75" class="accent-amber-500">
                        <label for="potato-large" class="text-gray-600">大 ($75)</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>

            <!-- 馬鈴薯燉肉蓋飯 (牛) -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="馬鈴薯燉肉蓋飯 (牛)">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">馬鈴薯燉肉蓋飯 (牛)</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="beef-potato-small" name="beef-potato-size" value="小" data-price="75" checked class="accent-amber-500">
                        <label for="beef-potato-small" class="text-gray-600">小 ($75)</label>
                        <input type="radio" id="beef-potato-large" name="beef-potato-size" value="大" data-price="85" class="accent-amber-500">
                        <label for="beef-potato-large" class="text-gray-600">大 ($85)</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>

            <!-- 烤肉飯 -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="烤肉飯">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">烤肉飯</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="bbq-small" name="bbq-size" value="小" data-price="85" checked class="accent-amber-500">
                        <label for="bbq-small" class="text-gray-600">小 ($85)</label>
                        <input type="radio" id="bbq-large" name="bbq-size" value="大" data-price="95" class="accent-amber-500">
                        <label for="bbq-large" class="text-gray-600">大 ($95)</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>

            <!-- 飲料區塊 -->
            <h2 class="text-xl font-semibold mt-6 mb-4 text-amber-700 border-b-2 border-amber-200 pb-2">飲料</h2>

            <!-- 紅茶 (冰) -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="紅茶 (冰)">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">紅茶 (冰)</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="tea-small" name="tea-size" value="小" data-price="15" checked class="accent-amber-500">
                        <label for="tea-small" class="text-gray-600">小 ($15)</label>
                        <input type="radio" id="tea-large" name="tea-size" value="大" data-price="20" class="accent-amber-500">
                        <label for="tea-large" class="text-gray-600">大 ($20)</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>
            
            <!-- 甘蔗青茶 (冰) -->
            <div class="order-item flex flex-col md:flex-row justify-between items-start md:items-center py-4 border-b border-dashed border-amber-100" data-item-name="甘蔗青茶 (冰)">
                <div class="item-info flex-grow">
                    <label class="font-bold text-gray-800">甘蔗青茶 (冰)</label>
                    <div class="item-options flex items-center gap-4 mt-2">
                        <input type="radio" id="sugarcane-small" name="sugarcane-size" value="小" data-price="35" checked class="accent-amber-500">
                        <label for="sugarcane-small" class="text-gray-600">小 ($35)</label>
                        <input type="radio" id="sugarcane-large" name="sugarcane-size" value="大" data-price="45" class="accent-amber-500">
                        <label for="sugarcane-large" class="text-gray-600">大 ($45)</label>
                    </div>
                </div>
                <!-- 數量控制區塊已更新 -->
                <div class="quantity-control flex items-center mt-3 md:mt-0">
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">-</button>
                    <span class="item-quantity w-12 text-center text-xl font-bold">0</span>
                    <button type="button" class="quantity-btn bg-amber-200 text-amber-800 font-bold w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-amber-300">+</button>
                    <button type="button" onclick="addToCart(this)" class="add-to-cart-btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 ml-4">加入購物車</button>
                </div>
            </div>

            <!-- 提交按鈕區塊 -->
            <div class="submit-section text-center mt-8">
                <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-full text-lg shadow-xl transition duration-300 ease-in-out transform hover:scale-105">送出訂單</button>
            </div>
        </form>
    </div>

    <!-- 驗證錯誤的自訂彈出視窗 -->
    <div id="validation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-red-600 mb-4" id="modal-heading">錯誤</h3>
            <p class="text-gray-700 mb-6" id="modal-message">請至少選擇一個商品後再送出訂單。</p>
            <button id="close-modal-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-full transition duration-300">確定</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const orderForm = document.getElementById('orderForm');
            const validationModal = document.getElementById('validation-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const orderSummaryList = document.getElementById('order-summary-list');
            const totalPriceSpan = document.getElementById('total-price');
            const orderDetailsInput = document.getElementById('order-details-input');
            const totalPriceInput = document.getElementById('total-price-input');
            const phoneNumberInput = document.getElementById('phone-number');
            const modalHeading = document.getElementById('modal-heading');

            let cartItems = [];

            // 根據 cartItems 陣列重新渲染購物車摘要和總價
            function renderCart() {
                orderSummaryList.innerHTML = '';
                let total = 0;
                let orderDetails = [];

                if (cartItems.length === 0) {
                    orderSummaryList.innerHTML = '<p class="text-gray-400">目前沒有商品在訂單中。</p>';
                } else {
                    cartItems.forEach((item, index) => {
                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.className = 'flex justify-between items-center py-1';
                        
                        let itemDescription = `${item.name}`;
                        if (item.size) itemDescription += ` (${item.size})`;
                        if (item.spicy) itemDescription += ` (${item.spicy})`;
                        itemDescription += ` x ${item.quantity}份`;

                        orderItemDiv.innerHTML = `
                            <span>${itemDescription} - $${item.price * item.quantity}</span>
                            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 transition" data-index="${index}">移除</button>
                        `;
                        orderSummaryList.appendChild(orderItemDiv);
                        total += item.price * item.quantity;
                        orderDetails.push(itemDescription);
                    });
                }

                totalPriceSpan.textContent = `$${total}`;
                totalPriceInput.value = total;
                orderDetailsInput.value = orderDetails.join(', ');
            }

            // 加入購物車功能
            window.addToCart = function(button) {
                const itemContainer = button.closest('.order-item');
                const itemName = itemContainer.dataset.itemName;
                const quantitySpan = itemContainer.querySelector('.item-quantity');
                const quantity = parseInt(quantitySpan.textContent);

                if (quantity <= 0) {
                    // 如果數量為0，不加入購物車
                    return;
                }

                const selectedSize = itemContainer.querySelector('input[name*="size"]:checked');
                const selectedSpicy = itemContainer.querySelector('input[name*="spicy"]:checked');
                
                const item = {
                    name: itemName,
                    size: selectedSize ? selectedSize.value : '',
                    price: selectedSize ? parseInt(selectedSize.dataset.price) : 0,
                    spicy: selectedSpicy ? selectedSpicy.value : '',
                    quantity: quantity
                };

                cartItems.push(item);
                renderCart();

                // 重設數量顯示
                quantitySpan.textContent = '0';
            };

            // 從購物車中移除項目
            function removeFromCart(index) {
                cartItems.splice(index, 1);
                renderCart();
            }

            // 監聽訂單摘要列表，處理移除按鈕的點擊事件
            orderSummaryList.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-item-btn')) {
                    const index = parseInt(event.target.dataset.index);
                    removeFromCart(index);
                }
            });

            // 監聽所有加減按鈕
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const itemContainer = button.closest('.order-item');
                    const quantitySpan = itemContainer.querySelector('.item-quantity');
                    let currentQuantity = parseInt(quantitySpan.textContent);
                    
                    if (button.textContent.trim() === '+') {
                        currentQuantity++;
                    } else if (button.textContent.trim() === '-' && currentQuantity > 0) {
                        currentQuantity--;
                    }
                    
                    quantitySpan.textContent = currentQuantity;
                });
            });
            
            // 提交表單時進行驗證
            orderForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // 阻止預設的表單提交
                
                const total = parseInt(totalPriceInput.value);
                const phoneNumber = phoneNumberInput.value.trim();
                let hasError = false;
                
                if (total === 0) {
                    modalHeading.textContent = '錯誤';
                    modalHeading.classList.add('text-red-600');
                    modalHeading.classList.remove('text-green-600');
                    document.getElementById('modal-message').textContent = '請至少選擇一個商品後再送出訂單。';
                    hasError = true;
                } else if (!/^\d{4}$/.test(phoneNumber)) {
                    modalHeading.textContent = '錯誤';
                    modalHeading.classList.add('text-red-600');
                    modalHeading.classList.remove('text-green-600');
                    document.getElementById('modal-message').textContent = '請輸入正確的手機末4碼 (4位數字)。';
                    hasError = true;
                }

                if (hasError) {
                    validationModal.classList.remove('hidden'); // 顯示彈出視窗
                    return;
                }
                
                // 準備表單數據
                const formData = new FormData(orderForm);
                const url = orderForm.action;
                
                try {
                    // 使用 fetch API 提交表單
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors' // Google Forms 需要這個模式
                    });

                    // 清空購物車和手機號碼
                    cartItems = [];
                    renderCart();
                    phoneNumberInput.value = '';

                    // 顯示訂單成功訊息
                    modalHeading.textContent = '訂單已送出';
                    modalHeading.classList.add('text-green-600');
                    modalHeading.classList.remove('text-red-600');
                    document.getElementById('modal-message').textContent = '您的訂單已成功送出，感謝您的購買！';
                    validationModal.classList.remove('hidden');

                } catch (error) {
                    console.error('表單提交失敗:', error);
                    modalHeading.textContent = '提交失敗';
                    modalHeading.classList.add('text-red-600');
                    modalHeading.classList.remove('text-green-600');
                    document.getElementById('modal-message').textContent = '送出訂單時發生錯誤，請稍後再試。';
                    validationModal.classList.remove('hidden');
                }
            });

            // 關閉彈出視窗
            closeModalBtn.addEventListener('click', () => {
                validationModal.classList.add('hidden');
            });

            // 初始化
            renderCart();
        });
    </script>
</body>
</html>
