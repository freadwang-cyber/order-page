<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐點訂單管理系統</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 min-h-screen flex flex-col items-center">
    <!-- Main App Container -->
    <div class="container mx-auto max-w-4xl p-4 bg-white shadow-xl rounded-xl">
        
        <!-- Header with tabs and revenue display -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-4 md:mb-0">訂單管理系統</h1>
            
            <div class="flex-grow flex justify-center md:justify-start">
                <button id="mainPageTab" class="bg-indigo-500 text-white px-6 py-2 rounded-full font-medium transition-colors hover:bg-indigo-600 mr-2">主頁面</button>
                <button id="historyPageTab" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-full font-medium transition-colors hover:bg-gray-400">歷史訂單</button>
            </div>
            
            <div class="flex items-center space-x-2 bg-green-100 text-green-700 font-bold px-4 py-2 rounded-lg shadow-md mt-4 md:mt-0">
                <span>今日營業額:</span>
                <span id="todaysRevenue" class="text-xl">載入中...</span>
            </div>
        </header>

        <!-- Main Orders List Section -->
        <main id="mainPage" class="space-y-4">
            <div id="ordersList" class="grid gap-4">
                <p id="loadingMessage" class="text-center text-gray-500">載入中，請稍候...</p>
            </div>
        </main>
        
        <!-- History Orders List Section -->
        <main id="historyPage" class="space-y-4 hidden">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">歷史訂單</h2>
            <div id="historyList" class="grid gap-4">
                <p id="historyLoadingMessage" class="text-center text-gray-500">載入中，請稍候...</p>
            </div>
        </main>

    </div>

    <!-- Message Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg p-6 w-80 shadow-lg transform scale-95 transition-transform duration-300">
            <p id="modalMessage" class="text-center text-lg font-medium text-gray-700 mb-4"></p>
            <button id="modalCloseBtn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors hover:bg-indigo-600">關閉</button>
        </div>
    </div>

    <script type="module">
        // =================================================================
        // ** 重要設定：請依據你的 Google Sheets 與 Google Forms 進行修改 **
        // =================================================================

        // 1. 原始訂單試算表的 Google Sheets API 連結
        //    請替換為你的試算表 URL
        const ORIGINAL_SHEET_URL = "https://docs.google.com/spreadsheets/d/1GHpU6B0gaPvIUZTarSIN_geddThGLYG9kkodNYARo3c/edit?usp=sharing";
        
        // 2. 歷史訂單表單的 Google Form 提交 URL
        //    如何取得：
        //    - 進入你的 Google 表單編輯頁面。
        //    - 點選右上角的「傳送」。
        //    - 選擇「< >」符號 (內嵌 HTML)。
        //    - 複製 `<form>` 標籤中的 `action` 屬性值，並貼到下方。
        //    - 範例: const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSe-xxxxxx-xxxxxx/formResponse";
        const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdTf1vWgXAch5YZkBKUX9VJyov6FqjoitHGBa8nBjZjVFl0PA/viewform?embedded=true";
        
        // 3. 歷史訂單表單的欄位名稱 (name attribute)
        //    如何取得：
        //    - 在表單編輯頁面，右鍵點擊每個問題的輸入框，選擇「檢查」(Inspect)。
        //    - 找到 `<input>`、`<select>` 或 `<textarea>` 標籤。
        //    - 複製 `name` 屬性的值，通常格式為 "entry.xxxxxxxxxx"。
        const FORM_FIELD_MAPPING = {
            orderId: 'entry.2106562066',      // 訂單編號
            mealName: 'entry.99877156',     // 餐點名稱
            price: 'entry.1051405435',       // 價格
            status: 'entry.1208958934',       // 狀態 (已出餐/已取消)
            timestamp: 'entry.1529076249'    // 訂單時間戳 (用來唯一識別訂單)
        };
        
        // 4. 歷史訂單試算表的 Google Sheets API 連結
        //    這是用來讀取已處理訂單的資料源。
        //    請替換為你歷史訂單試算表的 URL。
        const HISTORY_SHEET_URL = "https://docs.google.com/spreadsheets/d/1xD4X9yGZtEWzU8badXjUWleAaqIxK424ivXkTtdl2SA/edit?resourcekey=&gid=1893877126#gid=1893877126";


        // =================================================================
        // ** 程式碼邏輯，請勿修改 **
        // =================================================================

        const mainPage = document.getElementById('mainPage');
        const historyPage = document.getElementById('historyPage');
        const mainPageTab = document.getElementById('mainPageTab');
        const historyPageTab = document.getElementById('historyPageTab');
        const ordersList = document.getElementById('ordersList');
        const historyList = document.getElementById('historyList');
        const todaysRevenueEl = document.getElementById('todaysRevenue');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        
        let allOrders = [];
        let processedOrders = [];
        let loadingState = false;

        // 顯示訊息模態框
        const showModal = (message) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        };

        // 隱藏訊息模態框
        const hideModal = () => {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-0');
            }, 300);
        };
        modalCloseBtn.addEventListener('click', hideModal);

        // 處理 HTTP 請求並解析 CSV
        const fetchCSV = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                const text = await response.text();
                // 使用 headers 和 data 來解析 CSV 格式
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(',').map(header => header.trim());
                return lines.slice(1).map(line => {
                    const values = line.split(',').map(value => value.trim());
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index];
                        return obj;
                    }, {});
                });
            } catch (error) {
                console.error('讀取試算表失敗:', error);
                showModal('讀取資料失敗，請檢查網路或試算表 URL。');
                return [];
            }
        };

        // 獲取所有訂單數據
        const fetchData = async () => {
            if (loadingState) return;
            loadingState = true;
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('historyLoadingMessage').classList.remove('hidden');

            try {
                const [originalData, historyData] = await Promise.all([
                    fetchCSV(ORIGINAL_SHEET_URL),
                    fetchCSV(HISTORY_SHEET_URL)
                ]);

                allOrders = originalData;
                processedOrders = historyData;

                renderUI();
            } finally {
                loadingState = false;
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('historyLoadingMessage').classList.add('hidden');
            }
        };
        
        // 提交訂單狀態到 Google Form
        const submitToForm = async (order, status) => {
            if (!FORM_ACTION_URL || Object.values(FORM_FIELD_MAPPING).some(val => !val)) {
                showModal('請先在程式碼中設定 Google 表單的 URL 與欄位名稱！');
                return;
            }

            const formData = new FormData();
            formData.append(FORM_FIELD_MAPPING.orderId, order['訂單編號']);
            formData.append(FORM_FIELD_MAPPING.mealName, order['餐點名稱']);
            formData.append(FORM_FIELD_MAPPING.price, order['價格']);
            formData.append(FORM_FIELD_MAPPING.status, status);
            formData.append(FORM_FIELD_MAPPING.timestamp, order['時間戳']);

            try {
                await fetch(FORM_ACTION_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // 必須設定為 no-cors 才能成功提交到 Google 表單
                });
                showModal(`已成功將訂單狀態提交至表單。`);
                // 提交成功後重新載入資料以更新 UI
                setTimeout(fetchData, 1000);
            } catch (error) {
                console.error('提交表單失敗:', error);
                showModal('提交表單時發生錯誤，請稍後再試。');
            }
        };

        // 渲染主頁面與歷史訂單頁面的 UI
        const renderUI = () => {
            // 找出已處理的訂單ID
            const processedTimestamps = new Set(processedOrders.map(order => order['時間戳']));

            // 篩選出未處理和已處理的訂單
            const pendingOrders = allOrders.filter(order => !processedTimestamps.has(order['時間戳']));
            const confirmedOrDeletedOrders = allOrders.filter(order => processedTimestamps.has(order['時間戳']));

            // 渲染主頁面訂單
            renderOrders(pendingOrders, ordersList, false);
            // 渲染歷史訂單
            renderOrders(confirmedOrDeletedOrders, historyList, true);
            // 計算並顯示營業額
            renderTodaysRevenue();
        };

        const renderOrders = (orders, container, isHistory) => {
            container.innerHTML = '';
            if (orders.length === 0) {
                const message = isHistory ? '沒有歷史訂單' : '目前沒有待出訂單';
                container.innerHTML = `<p class="text-center text-gray-500 py-4">${message}</p>`;
                return;
            }

            orders.forEach(order => {
                const historyStatus = processedOrders.find(p => p['時間戳'] === order['時間戳'])?.['狀態'] || '';
                const isConfirmed = historyStatus === '已出餐';
                const isDeleted = historyStatus === '已取消';

                const orderCard = document.createElement('div');
                orderCard.className = `bg-white p-6 rounded-xl shadow-md transition-shadow hover:shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center ${isDeleted ? 'bg-red-100' : ''}`;
                orderCard.innerHTML = `
                    <div class="flex-grow mb-4 md:mb-0">
                        <div class="flex items-center space-x-2 text-xl font-bold">
                            <span class="text-indigo-500">#${order['訂單編號']}</span>
                            <span>桌號: ${order['桌號']}</span>
                            ${isHistory ? `<span class="text-sm font-normal ml-2 py-1 px-2 rounded-full text-white ${isDeleted ? 'bg-red-500' : 'bg-green-500'}">${historyStatus}</span>` : ''}
                        </div>
                        <p class="text-gray-600 mt-2">餐點名稱: ${order['餐點名稱']}</p>
                        <p class="text-lg font-semibold text-gray-900">價格: NT$${order['價格']}</p>
                    </div>
                    <div class="flex space-x-2">
                        ${!isHistory ? `
                            <button class="confirmBtn bg-green-500 text-white font-bold py-2 px-4 rounded-full transition-transform hover:scale-105 active:scale-95 shadow-md" data-timestamp="${order['時間戳']}">
                                確認出餐
                            </button>
                            <button class="deleteBtn bg-red-500 text-white font-bold py-2 px-4 rounded-full transition-transform hover:scale-105 active:scale-95 shadow-md" data-timestamp="${order['時間戳']}">
                                刪除餐點
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(orderCard);
            });

            // 綁定事件監聽器
            if (!isHistory) {
                container.querySelectorAll('.confirmBtn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timestamp = e.target.dataset.timestamp;
                        const orderToProcess = allOrders.find(o => o['時間戳'] === timestamp);
                        if (orderToProcess) {
                            submitToForm(orderToProcess, '已出餐');
                        }
                    });
                });
                container.querySelectorAll('.deleteBtn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timestamp = e.target.dataset.timestamp;
                        const orderToProcess = allOrders.find(o => o['時間戳'] === timestamp);
                        if (orderToProcess) {
                            submitToForm(orderToProcess, '已取消');
                        }
                    });
                });
            }
        };

        const renderTodaysRevenue = () => {
            const today = new Date().toISOString().split('T')[0];
            const todaysConfirmedOrders = processedOrders.filter(order => {
                const orderDate = order['時間戳'] ? new Date(order['時間戳']).toISOString().split('T')[0] : '';
                return orderDate === today && order['狀態'] === '已出餐';
            });
            const totalRevenue = todaysConfirmedOrders.reduce((sum, order) => {
                const price = parseFloat(order['價格']) || 0;
                return sum + price;
            }, 0);
            todaysRevenueEl.textContent = `NT$${totalRevenue.toLocaleString()}`;
        };

        // Tab 切換功能
        const switchTab = (activeTab, inactiveTab, activePage, inactivePage) => {
            activeTab.classList.remove('bg-gray-300', 'text-gray-700');
            activeTab.classList.add('bg-indigo-500', 'text-white');
            inactiveTab.classList.remove('bg-indigo-500', 'text-white');
            inactiveTab.classList.add('bg-gray-300', 'text-gray-700');
            activePage.classList.remove('hidden');
            inactivePage.classList.add('hidden');
        };

        mainPageTab.addEventListener('click', () => {
            switchTab(mainPageTab, historyPageTab, mainPage, historyPage);
        });

        historyPageTab.addEventListener('click', () => {
            switchTab(historyPageTab, mainPageTab, historyPage, mainPage);
        });

        // 初始載入資料
        window.onload = fetchData;
        // 定時刷新資料，例如每 30 秒
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
